// Prisma Schema for AutoCut
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 素材类型枚举
enum MediaType {
  VIDEO        // 视频
  IMAGE        // 图片
  AUDIO        // 音频/音乐
  SOUND_EFFECT // 音效
  FANCY_TEXT   // 花字
  FONT         // 字体
  STICKER      // 表情/贴纸
  EMOTION      // 情绪
  EFFECT       // 特效
  TRANSITION   // 转场
  TEMPLATE     // 模版
}

// 素材表
model Media {
  id            String    @id @default(uuid())
  name          String    // 显示名称
  filename      String    // 存储文件名
  type          MediaType // 素材类型
  mimeType      String    // MIME 类型
  size          Int       // 文件大小（字节）
  path          String    // 相对路径
  duration      Float?    // 视频/音频时长（秒）
  width         Int?      // 宽度（像素）
  height        Int?      // 高度（像素）
  thumbnailPath String?   // 缩略图路径
  description   String?   @db.Text // 描述
  isSystem      Boolean   @default(false) // 是否系统预设素材
  usageCount    Int       @default(0) // 使用次数（热度）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  tags       MediaTag[]
  projects   ProjectMedia[]
  categories MediaCategory[] // 多维度分类

  @@index([type])
  @@index([createdAt])
  @@index([usageCount])
  @@map("media")
}

// 素材标签表（保留旧表兼容）
model MediaTag {
  id    String  @id @default(uuid())
  name  String  @unique
  color String? // 标签颜色

  createdAt DateTime @default(now())

  // 关联
  media Media[]

  @@map("media_tags")
}

// ============================================
// 多维度分类系统
// ============================================

// 分类维度枚举
enum CategoryDimension {
  EMOTION   // 情绪维度
  INDUSTRY  // 行业/垂类
  STYLE     // 风格维度
  SCENE     // 场景维度
  PLATFORM  // 适配平台
  TEMPO     // 节奏/速度
  MOOD      // 氛围/调性
}

// 分类标签表
model CategoryTag {
  id          String            @id @default(uuid())
  dimension   CategoryDimension // 所属维度
  name        String            // 标签名称
  nameEn      String?           // 英文名称
  icon        String?           // 图标（emoji或图标名）
  color       String?           // 标签颜色
  description String?           // 描述
  sortOrder   Int               @default(0) // 排序
  isSystem    Boolean           @default(false) // 是否系统预设

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  media               MediaCategory[]
  platformPreferences PlatformPreference[]

  @@unique([dimension, name])
  @@index([dimension])
  @@index([sortOrder])
  @@map("category_tags")
}

// 素材分类关联表
model MediaCategory {
  id         String @id @default(uuid())
  mediaId    String
  categoryId String
  confidence Float? @default(1.0) // AI 推荐的置信度（0-1）

  createdAt DateTime @default(now())

  // 关联
  media    Media       @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  category CategoryTag @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([mediaId, categoryId])
  @@index([mediaId])
  @@index([categoryId])
  @@map("media_categories")
}

// 平台推荐配置表（存储各平台的偏好权重）
model PlatformPreference {
  id         String @id @default(uuid())
  platform   String // douyin, bilibili, xiaohongshu, kuaishou, weixin
  categoryId String
  weight     Float  @default(1.0) // 权重（0-2，1为标准）
  tips       String? @db.Text // 使用建议

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  category CategoryTag @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([platform, categoryId])
  @@index([platform])
  @@map("platform_preferences")
}

// 项目表
model Project {
  id           String  @id @default(uuid())
  name         String
  description  String? @db.Text
  targetDevice String  @default("phone") // phone | desktop
  videoType    String? // vlog, tutorial, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  media ProjectMedia[]

  @@index([createdAt])
  @@map("projects")
}

// 项目素材关联表
model ProjectMedia {
  id        String  @id @default(uuid())
  projectId String
  mediaId   String
  order     Int     @default(0) // 排序顺序
  isMain    Boolean @default(false) // 是否为主素材

  // 关联
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  media   Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([projectId, mediaId])
  @@index([projectId])
  @@index([mediaId])
  @@map("project_media")
}

// ============================================
// 模版系统
// ============================================

// 模版类型枚举
enum TemplateType {
  VIDEO_TEMPLATE      // 视频模版
  IMAGE_TEMPLATE      // 图片模版
  FANCY_TEXT_TEMPLATE // 花字模版
}

// 素材/模版来源枚举
enum AssetSource {
  SYSTEM       // 系统预设
  USER         // 用户创建
  AI_CRAWL     // AI 召唤
  AI_GENERATED // AI 生成
}

// 花字用途枚举
enum FancyTextUsage {
  TITLE          // 标题
  CHAPTER_TITLE  // 章节步骤标题
  GUIDE          // 操作指引
  EMPHASIS       // 强调特写
  PERSON_INTRO   // 人物介绍
  DIALOGUE       // 对话字幕
  ANNOTATION     // 旁白注释
  CALL_TO_ACTION // 互动引导
}

// 模版表
model Template {
  id          String       @id @default(uuid())
  type        TemplateType // 模版类型
  name        String       // 模版名称
  description String?      @db.Text // 描述
  thumbnail   String?      // 缩略图路径
  previewUrl  String?      // 预览视频路径
  
  // 参数定义（JSON）
  parameters  Json         // 存储 TemplateParameters 结构
  
  // 元数据
  source      AssetSource  @default(SYSTEM) // 来源
  userId      String?      // 用户创建时关联用户ID
  isPublic    Boolean      @default(true) // 是否公开
  usageCount  Int          @default(0) // 使用次数
  likes       Int          @default(0) // 点赞数
  views       Int          @default(0) // 浏览次数
  downloads   Int          @default(0) // 下载次数
  
  // 花字专用字段
  fancyTextUsage FancyTextUsage? // 花字用途
  duration       Float?          // 动画时长（秒）
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联
  tags      TemplateTag[]
  favorites UserFavorite[]
  
  @@index([type])
  @@index([source])
  @@index([usageCount])
  @@index([fancyTextUsage])
  @@map("templates")
}

// 模版标签关联表
model TemplateTag {
  id         String @id @default(uuid())
  templateId String
  tagName    String // 标签名称
  
  createdAt DateTime @default(now())
  
  // 关联
  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([templateId, tagName])
  @@index([templateId])
  @@index([tagName])
  @@map("template_tags")
}

// ============================================
// 用户收藏系统
// ============================================

// 收藏目标类型
enum FavoriteTargetType {
  MEDIA    // 素材
  TEMPLATE // 模版
}

// 用户收藏表
model UserFavorite {
  id         String             @id @default(uuid())
  userId     String             // 用户ID（预留，当前使用默认值）
  targetId   String             // 目标ID
  targetType FavoriteTargetType // 目标类型
  
  createdAt DateTime @default(now())
  
  // 关联（可选，根据 targetType 动态关联）
  template Template? @relation(fields: [targetId], references: [id], onDelete: Cascade, map: "fk_favorite_template")
  
  @@unique([userId, targetId, targetType])
  @@index([userId])
  @@index([targetId])
  @@index([targetType])
  @@map("user_favorites")
}

// ============================================
// 表情包系统
// ============================================

// 表情包表
model StickerPack {
  id          String      @id @default(uuid())
  name        String      // 表情包名称
  description String?     // 描述
  thumbnail   String?     // 封面图
  source      AssetSource @default(SYSTEM) // 来源
  userId      String?     // 用户导入时关联
  
  // 元数据（JSON）
  metadata    Json?       // 作者、版本、许可证等
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联
  stickers Sticker[]
  
  @@index([source])
  @@map("sticker_packs")
}

// 表情表
model Sticker {
  id       String  @id @default(uuid())
  packId   String  // 所属表情包
  name     String  // 表情名称
  url      String  // 文件路径
  format   String  // 格式：gif, png, apng, lottie, webp
  width    Int     // 宽度
  height   Int     // 高度
  duration Float?  // 动图时长（秒）
  
  // 标签（JSON数组）
  tags     Json    @default("[]")
  
  createdAt DateTime @default(now())
  
  // 关联
  pack StickerPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  
  @@index([packId])
  @@map("stickers")
}
